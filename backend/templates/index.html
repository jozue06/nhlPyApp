{% extends "layout.html" %}
	{% block body %}
		<script>
			let playerStates = {};

			async function toggleInfo(playerName) {
				const cleanName = playerName.trim();
				const infoDiv = document.getElementById(`infos-${cleanName.replace(/\s+/g, '-')}`);
				const button = document.getElementById(`btn-${cleanName.replace(/\s+/g, '-')}`);
				
				if (!playerStates[cleanName]) {
					playerStates[cleanName] = { loaded: false, visible: false };
				}
				
				const state = playerStates[cleanName];
				
				if (!state.loaded) {
					try {
						button.textContent = 'Loading...';
						button.disabled = true;
						
						const linkName = cleanName.replace(/\s+/g, '+');
						const response = await fetch(`https://autocomplete.eliteprospects.com/all?q=${linkName}`);
						const json = await response.json();
						
						if (!json || json.length === 0) {
							infoDiv.innerHTML = '<p style="color: #ff6b6b; padding: 10px;">No player information found</p>';
						} else {
							const found = json.length === 1 ? json[0] : json.find(e => e.fullname === cleanName);
							
							if (!found || !found.id) {
								infoDiv.innerHTML = `<p style="color: #ff6b6b; padding: 10px;">Player "${cleanName}" not found.</p>`;
							} else {
								const iframe = document.createElement('iframe');
								iframe.src = `https://www.eliteprospects.com/ajax/player.stats.default?playerId=${found.id}`;
								iframe.style.minWidth = "70vw";
								iframe.style.backgroundColor = "darkgray";
								iframe.style.border = "1px solid #00ff00";
								infoDiv.appendChild(iframe);
							}
						}
						
						state.loaded = true;
						state.visible = true;
						button.textContent = 'Hide Info';
						button.style.backgroundColor = '#ff6b6b';
						
					} catch (error) {
						infoDiv.innerHTML = '<p style="color: #ff6b6b; padding: 10px;">Error loading player information. Please try again.</p>';
						state.loaded = true;
						state.visible = true;
						button.textContent = 'Hide Info';
						button.style.backgroundColor = '#ff6b6b';
					}
					
					button.disabled = false;
				} else {
					const iframe = infoDiv.querySelector('iframe');
					const errorMsg = infoDiv.querySelector('p');
					
					if (state.visible) {
						if (iframe) {
							iframe.style.display = 'none';
						}
						if (errorMsg) {
							errorMsg.style.display = 'none';
						}
						state.visible = false;
						button.textContent = 'Show Info';
						button.style.backgroundColor = '#4ecdc4';
					} else {
						if (iframe) {
							iframe.style.display = 'block';
						}
						if (errorMsg) {
							errorMsg.style.display = 'block';
						}
						state.visible = true;
						button.textContent = 'Hide Info';
						button.style.backgroundColor = '#ff6b6b';
					}
				}
			}
		</script>

		<div class="input-wrapper">
			<form action="/api/html/search" method="post">
				<textarea name="queryString" class="terminal" autofocus="true" rows="10" cols="100"></textarea>
				<input type="submit">
			</form>
		</div>
		{% if results %}
			{% set total_players = [] %}
			{% for res in results %}
				{% if res and 'Player Full Name:' in res %}
					{% set _ = total_players.append(1) %}
				{% endif %}
			{% endfor %}
			{% if total_players | length > 0 %}
				<div style="color: #00ff00; padding: 10px; margin: 10px 0; font-weight: bold; text-align: center;">
					Total Players Found: {{ total_players | length }}
				</div>
			{% endif %}
		{% endif %}
		{% for res in results %}
			{% if res and 'Player Headshot:' in res and 'http' in res %}
				{% set headshot_url = res.split('Player Headshot: ')[1] %}
				<div style="margin: 10px 0;">
					<img src="{{ headshot_url }}" 
						 alt="Player headshot" 
						 style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px; border: 2px solid #00ff00;"
						 onerror="this.style.display='none';">
				</div>
			{% elif res and 'Player Full Name:' in res %}
				{% set player_name = res.split('Player Full Name: ')[1] %}
				{% set safe_id = player_name.replace(' ', '-') %}
				<p style="color: aqua !important;">
					{{ res }}
					<button id="btn-{{ safe_id }}" 
							onclick="toggleInfo('{{ player_name }}')"
							style="margin-left: 10px; padding: 5px 10px; background-color: #4ecdc4; color: white; border: none; border-radius: 3px; cursor: pointer;">
						Get Info
					</button>
				</p>
				<div id="infos-{{ safe_id }}" style="margin: 10px 0;"></div>
			{% elif res and 'Player Headshot:' not in res %}
				<p style="color: aqua !important;">
					{{ res }}
				</p>
			{% endif %}
		{% endfor %}
	{% endblock %}